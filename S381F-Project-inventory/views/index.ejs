<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="paper">
    <div class="topbar">
      <div class="md">
        <h1>Inventory List</h1>
        <p>Welcome，<strong><%= user %></strong></p>
      </div>
      <div class="actions">
        <a class="btn" href="/add">Add</a>
        <a class="btn" href="/logout">Logout</a>
      </div>
    </div>

    <section class="md">
      <h2>Read</h2>
      <form class="query-form" method="GET" action="/">
        <input class="input" name="q" value="<%= q || '' %>" placeholder="Keywords">
        <input class="input" type="number" name="min" value="<%= min || '' %>" placeholder="Min">
        <input class="input" type="number" name="max" value="<%= max || '' %>" placeholder="Max">
        <button class="btn" type="submit">Search</button>
        <a class="btn" href="/">Reset</a>
      </form>

      <div class="sep"></div>

      <h2>List</h2>
      <ul class="items">
        <% items.forEach(item => { %>
          <li
            data-dis-type="simultaneous"
            data-dis-particle-type="WindParticle"
            data-dis-reduction-factor="28">
            <div>
              <div><strong><%= item.name %></strong></div>
              <div class="item-meta">Quantity：<%= item.quantity %></div>
            </div>
            <div class="actions">
              <a class="btn" href="/delete/<%= item._id %>">Delete</a>
            </div>
          </li>
        <% }); %>
      </ul>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ZachSaucier/Disintegrate/disintegrate.js"></script>

  <!-- custom particle: WindParticle -->
  <script>
    (function(){
      function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      var WindParticle = function () {
        this.name = "WindParticle";
        this.animationDuration = 1200; // ms

        // 每顆粒子的隨機參數
        this._initOnce = false;
        this.draw = function(ctx, percent){
          if(!this._initOnce){
            this.size = 1 + Math.random() * 1;    // 像素大小
            this.wind = 30 + Math.random() * 20;  // 風力：水平位移總量
            this.lift = 10 + Math.random() * 20;    // 抬升：垂直位移總量
            this.swing = Math.random() * 6 + 3;    // 側向晃動幅度
            this.freq = Math.random() * 6 + 3;     // 晃動頻率
            this.fade = 0.85 + Math.random() * 0.25;// 透明度權重
            this.seed = Math.random() * Math.PI * 2;
            this._initOnce = true;
          }

          var t = easeOutCubic(percent);
          var nx = this.startX + t * this.wind + Math.sin(this.seed + t * this.freq) * this.swing;
          var ny = this.startY - t * this.lift + Math.cos(this.seed + t * this.freq * 0.7) * 4;

          var a = (1 - t) * (this.rgbArray[3] != null ? this.rgbArray[3] / 255 : 1) * this.fade;
          ctx.fillStyle = "rgba(" + this.rgbArray[0] + "," + this.rgbArray[1] + "," + this.rgbArray[2] + "," + a + ")";
          ctx.fillRect(nx, ny, this.size, this.size);
        };
      };

      if (window.disintegrate && typeof disintegrate.addParticleType === "function") {
        disintegrate.addParticleType(WindParticle);
      }
    })();
  </script>

  <!-- wire up delete -> wind disintegration -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      window.addEventListener('disesLoaded', function () {
        document.querySelectorAll('.items a[href^="/delete/"]').forEach(function (btn) {
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            const li   = this.closest('li');
            const href = this.getAttribute('href');

            const disObj = disintegrate.getDisObj(li);
            disintegrate.createSimultaneousParticles(disObj);
            li.style.visibility = 'hidden';

            li.addEventListener('disComplete', function onDone() {
              li.removeEventListener('disComplete', onDone);
              fetch(href, { method: 'GET', headers: { 'X-Requested-With': 'fetch' } })
                .finally(() => li.remove());
            });
          });
        });
      });
      disintegrate.init();
    });
  </script>
</body>
</html>
